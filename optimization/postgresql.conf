# ========================================
# PostgreSQL 15 性能优化配置
# 针对Debian内核优化的数据库配置
# 适用于：1-2GB内存的小型应用服务器
# ========================================

# ========================================
# 连接设置
# ========================================
max_connections = 100                        # 最大连接数（默认100）
superuser_reserved_connections = 3           # 超级用户预留连接数

# ========================================
# 内存配置（核心性能参数）
# ========================================

# 共享缓冲区（推荐物理内存的25%，最大不超过8GB）
shared_buffers = 256MB                       # 共享内存缓冲区

# 有效缓存大小（推荐物理内存的50-75%）
effective_cache_size = 1GB                   # 操作系统和数据库可用的缓存

# 工作内存（每个查询操作可用内存）
work_mem = 16MB                              # 排序、哈希等操作的内存
maintenance_work_mem = 64MB                  # 维护操作（VACUUM、CREATE INDEX）的内存

# 临时缓冲区
temp_buffers = 8MB                           # 临时表缓冲区

# ========================================
# WAL（Write-Ahead Logging）配置
# ========================================

# WAL写入优化
wal_buffers = 16MB                           # WAL缓冲区（默认-1自动，推荐shared_buffers的1/32）
wal_writer_delay = 200ms                     # WAL写入延迟（默认200ms）
wal_writer_flush_after = 1MB                 # WAL写入后刷新阈值

# WAL检查点优化
checkpoint_timeout = 10min                   # 检查点超时时间（默认5min）
checkpoint_completion_target = 0.9           # 检查点完成目标（默认0.9）
max_wal_size = 2GB                          # 最大WAL大小（默认1GB）
min_wal_size = 512MB                        # 最小WAL大小（默认80MB）

# WAL归档（如需备份，启用以下配置）
# archive_mode = on
# archive_command = 'test ! -f /backups/wal/%f && cp %p /backups/wal/%f'

# ========================================
# 查询规划器优化
# ========================================

# 成本参数
random_page_cost = 1.1                       # 随机页面访问成本（SSD推荐1.1，HDD推荐4.0）
effective_io_concurrency = 200               # 并发I/O操作数（SSD推荐200，HDD推荐2）

# 统计信息
default_statistics_target = 100              # 统计信息采样目标（默认100）

# ========================================
# 并发和锁配置
# ========================================

# 并发设置
max_worker_processes = 4                     # 最大后台工作进程数
max_parallel_workers_per_gather = 2          # 每个Gather节点的并行工作进程数
max_parallel_workers = 4                     # 最大并行工作进程数
max_parallel_maintenance_workers = 2         # 维护操作的并行工作进程数

# 锁配置
deadlock_timeout = 1s                        # 死锁检测超时时间

# ========================================
# 自动清理（VACUUM）优化
# ========================================

# 自动清理开关
autovacuum = on                              # 启用自动清理（默认on）

# 自动清理参数
autovacuum_max_workers = 3                   # 最大自动清理工作进程数
autovacuum_naptime = 1min                    # 自动清理休眠时间（默认1min）
autovacuum_vacuum_threshold = 50             # 触发VACUUM的最小更新行数
autovacuum_vacuum_scale_factor = 0.2         # 触发VACUUM的表大小比例
autovacuum_analyze_threshold = 50            # 触发ANALYZE的最小更新行数
autovacuum_analyze_scale_factor = 0.1        # 触发ANALYZE的表大小比例

# 清理成本限制
autovacuum_vacuum_cost_delay = 20ms          # 清理成本延迟
autovacuum_vacuum_cost_limit = 200           # 清理成本限制

# ========================================
# 日志配置
# ========================================

# 日志目的地
logging_collector = on                       # 启用日志收集器
log_destination = 'stderr'                   # 日志输出到标准错误

# 日志文件配置
log_directory = 'log'                        # 日志目录
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'  # 日志文件名格式
log_rotation_age = 1d                        # 日志轮转时间（1天）
log_rotation_size = 100MB                    # 日志轮转大小
log_truncate_on_rotation = off               # 不截断日志

# 日志内容
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '  # 日志行前缀
log_timezone = 'Asia/Shanghai'               # 日志时区

# 慢查询日志
log_min_duration_statement = 1000            # 记录执行时间超过1秒的查询
log_checkpoints = on                         # 记录检查点信息
log_connections = on                         # 记录连接信息
log_disconnections = on                      # 记录断开连接信息
log_lock_waits = on                          # 记录锁等待
log_temp_files = 0                           # 记录所有临时文件

# ========================================
# 客户端连接配置
# ========================================

# 连接超时
tcp_keepalives_idle = 60                     # TCP keepalive空闲时间（秒）
tcp_keepalives_interval = 10                 # TCP keepalive间隔（秒）
tcp_keepalives_count = 3                     # TCP keepalive重试次数

# 语句超时
statement_timeout = 30000                    # 语句超时时间（30秒，0表示禁用）
idle_in_transaction_session_timeout = 60000  # 事务空闲超时（60秒）

# ========================================
# 区域和格式化
# ========================================

datestyle = 'iso, mdy'                       # 日期格式
timezone = 'Asia/Shanghai'                   # 时区
lc_messages = 'C'                            # 消息语言
lc_monetary = 'C'                            # 货币格式
lc_numeric = 'C'                             # 数字格式
lc_time = 'C'                                # 时间格式
default_text_search_config = 'pg_catalog.english'  # 全文搜索配置

# ========================================
# 安全配置
# ========================================

# SSL配置（生产环境建议启用）
# ssl = on
# ssl_cert_file = '/etc/ssl/certs/server.crt'
# ssl_key_file = '/etc/ssl/private/server.key'

# 密码加密
password_encryption = scram-sha-256          # 使用SCRAM-SHA-256加密（PostgreSQL 14+）

# ========================================
# 扩展和特性
# ========================================

# 共享预加载库（需要的扩展）
# shared_preload_libraries = 'pg_stat_statements'

# ========================================
# 监控和统计
# ========================================

# 统计收集
track_activities = on                        # 跟踪活动
track_counts = on                            # 跟踪计数
track_io_timing = on                         # 跟踪I/O时间
track_functions = all                        # 跟踪函数调用

# 统计视图
stats_temp_directory = '/var/run/postgresql/stats_tmp'  # 统计临时目录

# ========================================
# 应用说明
# ========================================
# 1. 将此文件复制到容器内的 /etc/postgresql/postgresql.conf
# 2. 在docker-compose.yml中挂载此文件
# 3. 重启PostgreSQL容器应用配置
# 4. 验证配置：
#    docker exec -it credit_management_postgres psql -U postgres -c "SHOW shared_buffers;"
#
# 注意事项：
# - 根据实际内存大小调整 shared_buffers 和 effective_cache_size
# - 生产环境建议启用SSL和更严格的日志记录
# - 定期监控慢查询日志并优化SQL
