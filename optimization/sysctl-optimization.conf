# ========================================
# Debian内核优化配置 - 针对Docker微服务应用
# 适用于：Debian 13 (trixie) + 内核 6.12.x
# 项目：学分管理系统（PostgreSQL + Go微服务 + Redis）
# ========================================

# ========================================
# 1. 网络性能优化
# ========================================

# TCP连接队列优化
net.core.somaxconn = 4096                    # 增加socket监听队列（默认128）
net.core.netdev_max_backlog = 5000           # 增加网络设备接收队列（默认1000）
net.ipv4.tcp_max_syn_backlog = 8192          # 增加SYN队列长度（默认1024）

# TCP缓冲区优化
net.core.rmem_default = 262144               # 默认接收缓冲区256KB
net.core.rmem_max = 16777216                 # 最大接收缓冲区16MB
net.core.wmem_default = 262144               # 默认发送缓冲区256KB
net.core.wmem_max = 16777216                 # 最大发送缓冲区16MB
net.ipv4.tcp_rmem = 4096 87380 16777216      # TCP接收缓冲区：最小 默认 最大
net.ipv4.tcp_wmem = 4096 65536 16777216      # TCP发送缓冲区：最小 默认 最大

# TCP性能优化
net.ipv4.tcp_fastopen = 3                    # 启用TCP Fast Open（客户端和服务端）
net.ipv4.tcp_slow_start_after_idle = 0       # 禁用空闲后慢启动
net.ipv4.tcp_tw_reuse = 1                    # 允许TIME_WAIT socket重用
net.ipv4.tcp_fin_timeout = 30                # 减少FIN_WAIT2超时时间（默认60秒）
net.ipv4.tcp_keepalive_time = 600            # TCP keepalive探测间隔（默认7200秒）
net.ipv4.tcp_keepalive_probes = 3            # TCP keepalive探测次数
net.ipv4.tcp_keepalive_intvl = 15            # TCP keepalive探测间隔

# TCP拥塞控制（使用BBR算法 - 内核6.12支持）
net.core.default_qdisc = fq                  # 使用Fair Queue调度器
net.ipv4.tcp_congestion_control = bbr        # 使用BBR拥塞控制算法

# 连接跟踪优化（针对微服务架构）
net.netfilter.nf_conntrack_max = 262144      # 增加连接跟踪表大小
net.netfilter.nf_conntrack_tcp_timeout_established = 1200  # 已建立连接超时20分钟

# IPv4路由优化
net.ipv4.ip_local_port_range = 10000 65535   # 扩大本地端口范围
net.ipv4.ip_forward = 0                      # 禁用IP转发（非路由器）

# ========================================
# 2. 内存管理优化（针对PostgreSQL）
# ========================================

# 虚拟内存优化
vm.swappiness = 10                           # 降低swap使用倾向（默认60，数据库推荐10）
vm.dirty_ratio = 15                          # 脏页比例达到15%时同步写入（默认20）
vm.dirty_background_ratio = 5                # 后台写入脏页比例5%（默认10）
vm.dirty_expire_centisecs = 500              # 脏页过期时间5秒（默认3000）
vm.dirty_writeback_centisecs = 100           # 脏页回写间隔1秒（默认500）

# 内存过度分配（PostgreSQL推荐）
vm.overcommit_memory = 2                     # 严格过度分配（0=启发式，1=总是，2=严格）
vm.overcommit_ratio = 80                     # 允许分配物理内存+swap的80%

# 透明大页（PostgreSQL推荐禁用）
vm.nr_hugepages = 0                          # 不预分配大页
# 注意：需要在 /sys/kernel/mm/transparent_hugepage/enabled 中设置为 madvise 或 never

# 内存回收优化
vm.min_free_kbytes = 65536                   # 保留最小空闲内存64MB
vm.vfs_cache_pressure = 50                   # 降低缓存回收压力（默认100）

# ========================================
# 3. 文件系统优化
# ========================================

# 文件描述符限制
fs.file-max = 2097152                        # 系统最大文件描述符数（默认约100万）
fs.nr_open = 2097152                         # 进程最大文件描述符数

# inotify限制（针对开发环境文件监控）
fs.inotify.max_user_watches = 524288         # 增加inotify监控数量
fs.inotify.max_user_instances = 512          # 增加inotify实例数

# AIO优化（PostgreSQL异步I/O）
fs.aio-max-nr = 1048576                      # 最大异步I/O请求数

# ========================================
# 4. 内核安全优化
# ========================================

# SYN flood防护
net.ipv4.tcp_syncookies = 1                  # 启用SYN cookies
net.ipv4.tcp_max_syn_backlog = 8192          # 增加SYN队列

# ICMP优化
net.ipv4.icmp_echo_ignore_broadcasts = 1     # 忽略广播ping
net.ipv4.icmp_ignore_bogus_error_responses = 1  # 忽略伪造ICMP错误

# IP源路由保护
net.ipv4.conf.all.accept_source_route = 0    # 禁用源路由
net.ipv4.conf.default.accept_source_route = 0

# 反向路径过滤
net.ipv4.conf.all.rp_filter = 1              # 启用反向路径过滤
net.ipv4.conf.default.rp_filter = 1

# ========================================
# 5. Docker/容器优化
# ========================================

# 内核命名空间
kernel.pid_max = 4194304                     # 增加最大PID数（支持更多容器）

# 共享内存（PostgreSQL需要）
kernel.shmmax = 17179869184                  # 最大共享内存段16GB
kernel.shmall = 4194304                      # 总共享内存页数（16GB/4KB）
kernel.shmmni = 4096                         # 最大共享内存段数

# 信号量（PostgreSQL需要）
kernel.sem = 250 32000 100 128               # SEMMSL SEMMNS SEMOPM SEMMNI

# ========================================
# 6. 性能监控和调试
# ========================================

# 内核消息缓冲区
kernel.printk = 3 4 1 3                      # 控制台日志级别
kernel.dmesg_restrict = 1                    # 限制非root用户访问dmesg

# Core dump配置
kernel.core_uses_pid = 1                     # core文件包含PID
kernel.core_pattern = /tmp/core-%e-%p-%t     # core文件命名模式

# ========================================
# 应用说明
# ========================================
# 1. 将此文件复制到 /etc/sysctl.d/99-credit-management.conf
# 2. 运行: sudo sysctl -p /etc/sysctl.d/99-credit-management.conf
# 3. 或重启系统自动应用
# 4. 验证: sysctl -a | grep <参数名>
