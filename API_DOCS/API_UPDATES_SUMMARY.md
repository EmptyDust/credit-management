# API 文档更新总结

## 概述

本文档总结了近期对 API_DOCS 目录中所有文档的更新，包括新增的批量操作接口、统一搜索接口以及相关的文档完善。

## 新增接口列表

### 1. 批量活动管理接口

#### 1.1 批量创建活动

- **接口**: `POST /api/activities/batch`
- **权限**: 所有认证用户
- **功能**: 批量创建多个活动（最多 10 个）
- **文档位置**: `credit-activity-API.md` 1.4 节

#### 1.2 批量更新活动

- **接口**: `PUT /api/activities/batch`
- **权限**: 所有认证用户（只能更新自己创建的活动）
- **功能**: 批量更新多个活动，支持主表和详情表的批量更新
- **文档位置**: `credit-activity-API.md` 1.5 节

#### 1.3 批量删除活动

- **接口**: `POST /api/activities/batch-delete`
- **权限**: 管理员
- **功能**: 批量软删除活动
- **文档位置**: `credit-activity-API.md` 1.14 节

### 2. 批量参与者管理接口

#### 2.1 批量设置参与者学分

- **接口**: `PUT /api/activities/:id/participants/batch-credits`
- **权限**: 活动创建者、管理员
- **功能**: 批量设置多个参与者的学分
- **文档位置**: `credit-activity-API.md` 3.4 节

#### 2.2 批量删除参与者

- **接口**: `POST /api/activities/:id/participants/batch-remove`
- **权限**: 活动创建者、管理员
- **功能**: 批量删除多个参与者
- **文档位置**: `credit-activity-API.md` 3.6 节

### 3. 批量附件管理接口

#### 3.1 批量上传附件

- **接口**: `POST /api/activities/:id/attachments/batch`
- **权限**: 活动创建者、参与者、管理员
- **功能**: 批量上传多个附件（最多 10 个文件）
- **文档位置**: `credit-activity-API.md` 4.3 节

### 4. 批量用户管理接口

#### 4.1 批量删除用户

- **接口**: `POST /api/users/batch_delete`
- **权限**: 管理员
- **功能**: 批量软删除用户
- **文档位置**: `user-service-API.md` 批量用户管理接口 1 节

#### 4.2 批量更新用户状态

- **接口**: `POST /api/users/batch_status`
- **权限**: 管理员
- **功能**: 批量更新用户状态
- **文档位置**: `user-service-API.md` 批量用户管理接口 2 节

### 5. 统一搜索接口

#### 5.1 统一活动搜索

- **接口**: `GET /api/search/activities`
- **权限**: 所有认证用户（学生只能看到自己创建或参与的活动）
- **功能**: 提供统一的活动搜索功能，支持多条件筛选和分页
- **文档位置**: `credit-activity-API.md` 10.1 节

#### 5.2 统一申请搜索

- **接口**: `GET /api/search/applications`
- **权限**: 所有认证用户（学生只能看到自己的申请）
- **功能**: 提供统一的申请搜索功能，支持多条件筛选和分页
- **文档位置**: `credit-activity-API.md` 10.2 节

#### 5.3 统一参与者搜索

- **接口**: `GET /api/search/participants`
- **权限**: 所有认证用户（学生只能看到自己参与的活动）
- **功能**: 提供统一的参与者搜索功能，支持多条件筛选和分页
- **文档位置**: `credit-activity-API.md` 10.3 节

#### 5.4 统一附件搜索

- **接口**: `GET /api/search/attachments`
- **权限**: 所有认证用户（学生只能看到自己创建或参与活动的附件）
- **功能**: 提供统一的附件搜索功能，支持多条件筛选和分页
- **文档位置**: `credit-activity-API.md` 10.4 节

## 文档更新详情

### 1. credit-activity-API.md 更新

#### 新增内容

- 1.5 节：批量更新活动接口详细文档
- 10 节：统一搜索 API 完整文档
  - 10.1 节：统一活动搜索
  - 10.2 节：统一申请搜索
  - 10.3 节：统一参与者搜索
  - 10.4 节：统一附件搜索
  - 10.5 节：搜索功能说明

#### 更新内容

- 重新编号了所有接口章节（1.5-1.16）
- 补充了批量接口的详细请求体、响应体和错误处理示例
- 添加了活动类型详情表的字段说明

### 2. UNIFIED_ACTIVITY_API.md 更新

#### 新增内容

- 5 节：统一搜索路由表
- 更新权限矩阵，添加批量操作和搜索功能权限

#### 更新内容

- 权限矩阵增加了批量操作和搜索功能的权限说明
- 添加了学生权限限制说明（\*学生只能搜索到自己创建或参与的内容）

### 3. user-service-API.md 更新

#### 新增内容

- 批量用户管理接口完整章节
  - 批量删除用户
  - 批量更新用户状态
  - 重置用户密码
  - 修改自己密码
  - 获取用户活动
  - 获取指定用户活动
  - 导出用户数据
  - CSV 批量导入用户
  - 获取 CSV 模板
- 批量操作说明章节

### 4. README.md 更新

#### 更新内容

- 更新日志部分添加 v2.1.0 版本说明
- 详细列出了所有新增的批量操作接口
- 说明了统一搜索接口的功能
- 提到了活动类型详情表的支持

## 技术特性

### 批量操作特性

1. **事务安全**: 所有批量操作都使用数据库事务确保数据一致性
2. **错误处理**: 支持部分成功，返回详细的成功和失败信息
3. **权限验证**: 每个操作都会验证用户权限
4. **软删除**: 删除操作采用软删除方式，数据不会真正删除
5. **日志记录**: 所有批量操作都会记录详细的操作日志

### 搜索功能特性

1. **模糊搜索**: 支持关键词的模糊匹配
2. **多条件筛选**: 支持多个条件的组合筛选
3. **分页支持**: 支持分页查询，避免大量数据返回
4. **排序功能**: 支持多种字段的升序/降序排序
5. **权限控制**: 根据用户角色自动过滤数据

### 性能优化

1. **索引优化**: 对常用搜索字段建立数据库索引
2. **查询优化**: 使用高效的 SQL 查询语句
3. **缓存支持**: 对搜索结果进行适当缓存
4. **分页限制**: 限制每页最大返回数量为 100

## 使用建议

### 批量操作建议

1. **批量大小**: 建议单次批量操作不超过 100 个记录
2. **权限检查**: 确保有足够的权限执行批量操作
3. **数据备份**: 执行重要批量操作前建议备份数据
4. **错误处理**: 仔细检查返回的错误信息，及时处理失败的操作
5. **性能考虑**: 大量数据操作时注意系统性能影响

### 搜索功能建议

1. **合理使用搜索条件**: 避免过于复杂的查询
2. **使用分页功能**: 处理大量数据时使用分页
3. **选择合适的排序字段**: 根据实际需求选择排序字段
4. **注意权限限制**: 确保只能访问有权限的数据

## 兼容性说明

### 向后兼容

- 所有新增接口都是向后兼容的
- 现有接口的请求和响应格式保持不变
- 权限控制逻辑保持一致

### 数据库变更

- 新增了活动类型详情表
- 现有数据结构和 API 保持不变
- 支持渐进式迁移

## 测试建议

### 批量操作测试

1. 测试正常批量操作流程
2. 测试部分失败的错误处理
3. 测试权限验证
4. 测试事务回滚机制

### 搜索功能测试

1. 测试各种搜索条件组合
2. 测试分页和排序功能
3. 测试权限过滤
4. 测试性能表现

## 后续计划

### 短期计划

1. 完善前端批量操作界面
2. 优化搜索性能
3. 添加更多搜索条件

### 长期计划

1. 支持更复杂的搜索语法
2. 添加搜索历史功能
3. 实现搜索建议功能
4. 支持全文搜索

---

**文档版本**: v2.1.0  
**更新时间**: 2024 年 1 月  
**维护者**: 开发团队

## 权限控制修复说明

### 修复内容

#### 1. 单个活动删除权限控制

- **问题**: `DeleteActivity` 函数调用了不存在的存储过程 `delete_activity_with_permission_check`
- **修复**: 在数据库初始化脚本中添加了该存储过程，确保权限检查正确执行
- **权限规则**: 只有活动创建者和管理员可以删除活动

#### 2. 批量更新活动权限控制

- **问题**: `BatchUpdateActivities` 函数缺少权限检查，存在安全漏洞
- **修复**: 添加了完整的权限检查逻辑
- **权限规则**:
  - 只有活动创建者和管理员可以更新活动
  - 只有草稿状态的活动可以修改（管理员除外）
  - 每个活动都会进行独立的权限验证

#### 3. 数据库存储过程

- **新增**: `delete_activity_with_permission_check` 函数
- **功能**: 执行单个活动删除的权限检查和级联删除
- **权限验证**: 检查用户是否为活动创建者或管理员
- **级联删除**: 软删除活动及其相关的参与者、申请、附件

#### 4. 附件权限控制修复

- **问题**: 教师角色在附件操作中权限不足，无法查看、下载所有活动的附件
- **修复**: 更新所有附件相关接口的权限控制逻辑
- **权限规则**:
  - **学生**:
    - 查看/下载：只能操作自己创建或参与活动的附件
    - 上传/更新/删除：只能操作自己创建的活动附件
  - **教师**:
    - 查看/下载：可以操作所有活动的附件
    - 上传/更新/删除：只能操作自己创建的活动附件
  - **管理员**: 可以操作所有活动的附件（查看、下载、上传、更新、删除）
- **修复的接口**:
  - `GetAttachments`: 查看附件列表
  - `UploadAttachment`: 上传单个附件
  - `BatchUploadAttachments`: 批量上传附件
  - `DownloadAttachment`: 下载附件
  - `UpdateAttachment`: 更新附件信息
  - `DeleteAttachment`: 删除附件

### 安全改进

1. **权限验证**: 所有活动操作都经过严格的权限检查
2. **状态验证**: 非管理员用户只能修改草稿状态的活动
3. **事务安全**: 批量操作使用数据库事务确保数据一致性
4. **错误处理**: 详细的错误信息帮助用户了解权限问题

### 测试建议

1. **权限测试**: 测试不同角色用户对活动的操作权限
2. **状态测试**: 测试不同状态活动的修改限制
3. **批量操作测试**: 测试批量更新和删除的权限控制
4. **错误处理测试**: 验证权限不足时的错误响应

### 兼容性说明

- 现有 API 接口保持不变
- 权限控制逻辑向后兼容
- 数据库结构无变化，仅添加存储过程
