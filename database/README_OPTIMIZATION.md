# 数据库优化说明文档

## 概述

本文档介绍了双创分申请平台数据库的优化版本，主要目标是确保数据库、后端 API 和前端验证规则的约束一致性，提升系统性能和数据完整性。

## 优化内容

### 1. 用户表优化

#### 字段长度和格式约束

- **用户名**: `VARCHAR(20)`，只允许字母、数字和下划线
- **手机号**: `VARCHAR(11)`，必须符合中国手机号格式（1 开头，11 位数字）
- **学号**: `VARCHAR(8)`，必须为 8 位数字
- **年级**: `VARCHAR(4)`，必须为 4 位数字
- **真实姓名**: `VARCHAR(50)`，限制长度

#### 状态约束

- 用户状态必须为：`active`、`inactive`、`suspended`

#### 验证触发器

- 自动验证邮箱格式
- 自动验证手机号格式
- 自动验证学号格式
- 自动验证年级格式
- 自动验证用户名格式

### 2. 活动表优化

#### 业务逻辑约束

- **标题**: 不能为空或只包含空白字符
- **类别**: 不能为空或只包含空白字符
- **日期**: 结束日期必须大于等于开始日期
- **状态**: 必须为 `draft`、`pending_review`、`approved`、`rejected`

### 3. 参与者表优化

#### 学分约束

- 学分必须为非负数

### 4. 申请表优化

#### 学分约束

- 申请学分必须为非负数
- 获得学分必须为非负数

### 5. 附件表优化

#### 文件约束

- **文件大小**: 最大 20MB
- **文件类型**: 支持白名单格式（PDF、DOC、图片、视频、音频、压缩包等）
- **文件类别**: 必须为预定义类别
- **文件名**: 不能为空或只包含空白字符
- **下载次数**: 必须为非负数

### 6. 索引优化

#### 复合索引

- 用户类型+状态索引
- 学院+专业索引
- 部门+职称索引
- 活动所有者+状态索引
- 活动类别+状态索引

#### 唯一索引

- 活动参与者唯一性约束（软删除除外）

### 7. 验证函数

#### 密码复杂度验证

- 长度至少 8 位
- 包含大写字母
- 包含小写字母
- 包含数字

#### 邮箱格式验证

- 符合标准邮箱格式

#### 文件类型验证

- 支持的文件类型白名单

#### 文件大小验证

- 最大 20MB 限制

### 8. 触发器功能

#### 自动维护

- 更新时间戳
- 活动通过后自动生成申请
- 活动撤回时删除相关申请
- 附件删除时清理孤立文件

#### 数据验证

- 用户数据插入/更新时自动验证格式

## 文件说明

### 1. `init_optimized.sql`

- **用途**: 全新的优化数据库初始化脚本
- **适用场景**: 新环境部署
- **特点**: 包含所有优化约束和功能

### 2. `migration_to_optimized.sql`

- **用途**: 从旧版本升级到优化版本
- **适用场景**: 现有环境升级
- **特点**: 保留现有数据，添加新约束

### 3. `constraint_fixes.sql`

- **用途**: 约束修复脚本（旧版本）
- **适用场景**: 已废弃，建议使用新版本

## 使用方法

### 新环境部署

```bash
# 1. 连接到PostgreSQL数据库
psql -h localhost -U postgres -d credit_management

# 2. 执行优化初始化脚本
\i init_optimized.sql
```

### 现有环境升级

```bash
# 1. 备份现有数据库
pg_dump -h localhost -U postgres credit_management > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. 连接到数据库
psql -h localhost -U postgres -d credit_management

# 3. 执行迁移脚本
\i migration_to_optimized.sql
```

### Docker 环境

```bash
# 1. 进入数据库容器
docker exec -it credit_management_postgres bash

# 2. 连接到数据库
psql -U postgres -d credit_management

# 3. 执行脚本
\i /docker-entrypoint-initdb.d/init_optimized.sql
```

## 约束一致性

### 数据库层面

- 字段长度限制
- 格式验证约束
- 业务逻辑约束
- 触发器自动验证

### 后端 API 层面

- Go 结构体标签验证
- 自定义验证函数
- 错误信息统一

### 前端层面

- Zod 验证模式
- 实时表单验证
- 用户友好的错误提示

## 性能优化

### 索引策略

- 单字段索引：常用查询字段
- 复合索引：多条件查询
- 唯一索引：数据完整性
- 部分索引：软删除过滤

### 查询优化

- 避免全表扫描
- 利用索引覆盖
- 合理使用视图

## 数据完整性

### 外键约束

- 级联删除
- 级联更新
- 引用完整性

### 业务约束

- 状态流转逻辑
- 学分计算规则
- 文件管理策略

## 安全考虑

### 数据验证

- 输入格式验证
- 业务规则验证
- SQL 注入防护

### 权限控制

- 基于角色的访问控制
- 数据隔离
- 操作审计

## 监控和维护

### 性能监控

```sql
-- 查看慢查询
SELECT query, mean_time, calls
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;

-- 查看索引使用情况
SELECT schemaname, tablename, indexname, idx_scan, idx_tup_read, idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

### 数据清理

```sql
-- 清理软删除数据（谨慎使用）
DELETE FROM users WHERE deleted_at < NOW() - INTERVAL '1 year';
DELETE FROM credit_activities WHERE deleted_at < NOW() - INTERVAL '1 year';
```

## 故障排除

### 常见问题

1. **约束冲突**

   - 检查数据格式是否符合新约束
   - 使用迁移脚本清理无效数据

2. **性能下降**

   - 检查索引是否正确创建
   - 分析慢查询日志

3. **触发器错误**
   - 检查触发器函数语法
   - 验证依赖函数是否存在

### 回滚方案

如果升级后出现问题，可以回滚到备份：

```bash
# 恢复备份
psql -h localhost -U postgres -d credit_management < backup_20231201_120000.sql
```

## 版本历史

### v2.0.0 (优化版本)

- 完整的约束一致性
- 性能优化
- 数据完整性增强
- 安全加固

### v1.0.0 (原始版本)

- 基础功能实现
- 简单约束
- 基本索引

## 联系信息

如有问题或建议，请联系开发团队。

---

**注意**: 在生产环境执行任何数据库脚本前，请务必进行充分测试和备份。
