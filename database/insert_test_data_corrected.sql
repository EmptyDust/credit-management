-- 测试数据插入脚本（修正版）
-- 匹配实际数据库结构：使用uuid、department_id、JSONB details等

-- ========================================
-- 1. 插入测试用户数据
-- ========================================

-- 获取一些部门ID用于用户关联
DO $$
DECLARE
    cs_dept_id UUID;
    se_class_id UUID;
    ee_class_id UUID;
    ai_class_id UUID;
BEGIN
    -- 获取计算机科学与技术学部
    SELECT id INTO cs_dept_id FROM departments WHERE name = '计算机科学与技术学部' AND dept_type = 'college' LIMIT 1;

    -- 获取软件工程专业的一个班级
    SELECT id INTO se_class_id FROM departments WHERE code = '2024222' AND dept_type = 'class' LIMIT 1;

    -- 获取电气工程专业的一个班级
    SELECT id INTO ee_class_id FROM departments WHERE code = '2022051' AND dept_type = 'class' LIMIT 1;

    -- 获取人工智能学部的一个班级
    SELECT id INTO ai_class_id FROM departments WHERE code = '202205C' AND dept_type = 'class' LIMIT 1;

    -- 插入教师用户
    INSERT INTO users (uuid, student_id, teacher_id, username, password, email, phone, real_name, user_type, status, department_id, title, grade)
    VALUES
    ('22222222-2222-2222-2222-222222222222', NULL, 'T0001', 'teacher_zhang', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'zhang@university.edu.cn', '13800138001', '张教授', 'teacher', 'active', cs_dept_id, '教授', NULL),
    ('22222222-2222-2222-2222-222222222223', NULL, 'T0002', 'teacher_li', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'li@university.edu.cn', '13800138002', '李副教授', 'teacher', 'active', cs_dept_id, '副教授', NULL),
    ('22222222-2222-2222-2222-222222222224', NULL, 'T0003', 'teacher_wang', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'wang@university.edu.cn', '13800138003', '王讲师', 'teacher', 'active', cs_dept_id, '讲师', NULL)
    ON CONFLICT (uuid) DO NOTHING;

    -- 插入学生用户
    INSERT INTO users (uuid, student_id, teacher_id, username, password, email, phone, real_name, user_type, status, department_id, title, grade)
    VALUES
    ('33333333-3333-3333-3333-333333333333', '20240001', NULL, 'student_zhang', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'student1@university.edu.cn', '13800138006', '张三', 'student', 'active', se_class_id, NULL, '2024'),
    ('33333333-3333-3333-3333-333333333334', '20240002', NULL, 'student_li', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'student2@university.edu.cn', '13800138007', '李四', 'student', 'active', se_class_id, NULL, '2024'),
    ('33333333-3333-3333-3333-333333333335', '20240003', NULL, 'student_wang', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'student3@university.edu.cn', '13800138008', '王五', 'student', 'active', se_class_id, NULL, '2024'),
    ('33333333-3333-3333-3333-333333333336', '20220001', NULL, 'student_zhao', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'student4@university.edu.cn', '13800138009', '赵六', 'student', 'active', ee_class_id, NULL, '2022'),
    ('33333333-3333-3333-3333-333333333337', '20220002', NULL, 'student_qian', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'student5@university.edu.cn', '13800138010', '钱七', 'student', 'active', ee_class_id, NULL, '2022'),
    ('33333333-3333-3333-3333-333333333338', '20220003', NULL, 'student_sun', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'student6@university.edu.cn', '13800138011', '孙八', 'student', 'active', ai_class_id, NULL, '2022'),
    ('33333333-3333-3333-3333-333333333339', '20220004', NULL, 'student_zhou', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'student7@university.edu.cn', '13800138012', '周九', 'student', 'active', ai_class_id, NULL, '2022'),
    ('33333333-3333-3333-3333-333333333340', '20220005', NULL, 'student_wu', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'student8@university.edu.cn', '13800138013', '吴十', 'student', 'active', ai_class_id, NULL, '2022')
    ON CONFLICT (uuid) DO NOTHING;

END $$;

-- ========================================
-- 2. 插入学分活动数据（使用JSONB details字段）
-- ========================================

-- 创新创业实践活动
INSERT INTO credit_activities (id, title, description, start_date, end_date, status, category, owner_id, reviewer_id, details)
VALUES
('44444444-4444-4444-4444-444444444444', '互联网+创新创业大赛', '参加全国互联网+创新创业大赛，展示创新项目', '2024-03-01', '2024-06-30', 'approved', '创新创业实践活动', '33333333-3333-3333-3333-333333333333', '22222222-2222-2222-2222-222222222222',
 '{"item": "互联网+创新创业大赛", "company": "教育部", "project_no": "INT2024001", "issuer": "教育部高等教育司", "date": "2024-06-30", "total_hours": 120.00}'::jsonb),
('44444444-4444-4444-4444-444444444445', '大学生创新创业训练计划', '参与校级创新创业训练计划项目', '2024-02-15', '2024-08-15', 'approved', '创新创业实践活动', '33333333-3333-3333-3333-333333333334', '22222222-2222-2222-2222-222222222223',
 '{"item": "大学生创新创业训练计划", "company": "学校教务处", "project_no": "INN2024002", "issuer": "学校创新创业学部", "date": "2024-08-15", "total_hours": 200.00}'::jsonb),
('44444444-4444-4444-4444-444444444446', '科技创新实验室项目', '在科技创新实验室参与研发项目', '2024-01-10', '2024-12-31', 'approved', '创新创业实践活动', '33333333-3333-3333-3333-333333333335', '22222222-2222-2222-2222-222222222224',
 '{"item": "科技创新实验室项目", "company": "学校科技处", "project_no": "TEC2024003", "issuer": "学校科技处", "date": "2024-12-31", "total_hours": 300.00}'::jsonb)
ON CONFLICT (id) DO NOTHING;

-- 学科竞赛
INSERT INTO credit_activities (id, title, description, start_date, end_date, status, category, owner_id, reviewer_id, details)
VALUES
('44444444-4444-4444-4444-444444444447', '全国大学生数学建模竞赛', '参加全国大学生数学建模竞赛并获得省级奖项', '2024-09-01', '2024-09-30', 'approved', '学科竞赛', '33333333-3333-3333-3333-333333333336', '22222222-2222-2222-2222-222222222222',
 '{"level": "省级", "competition": "全国大学生数学建模竞赛", "award_level": "二等奖", "rank": "第5名"}'::jsonb),
('44444444-4444-4444-4444-444444444448', 'ACM程序设计竞赛', '参加ACM国际大学生程序设计竞赛', '2024-10-15', '2024-11-15', 'approved', '学科竞赛', '33333333-3333-3333-3333-333333333337', '22222222-2222-2222-2222-222222222223',
 '{"level": "国家级", "competition": "ACM程序设计竞赛", "award_level": "三等奖", "rank": "第15名"}'::jsonb),
('44444444-4444-4444-4444-444444444449', '全国大学生电子设计竞赛', '参加全国大学生电子设计竞赛', '2024-08-01', '2024-08-31', 'approved', '学科竞赛', '33333333-3333-3333-3333-333333333338', '22222222-2222-2222-2222-222222222224',
 '{"level": "省级", "competition": "全国大学生电子设计竞赛", "award_level": "一等奖", "rank": "第2名"}'::jsonb)
ON CONFLICT (id) DO NOTHING;

-- 大学生创业项目
INSERT INTO credit_activities (id, title, description, start_date, end_date, status, category, owner_id, reviewer_id, details)
VALUES
('44444444-4444-4444-4444-444444444450', '校园二手交易平台创业项目', '开发校园二手交易平台，提供学生二手物品交易服务', '2024-03-15', '2024-12-31', 'approved', '大学生创业项目', '33333333-3333-3333-3333-333333333339', '22222222-2222-2222-2222-222222222222',
 '{"project_name": "校园二手交易平台", "project_level": "校级", "project_rank": "优秀"}'::jsonb),
('44444444-4444-4444-4444-444444444451', '智能校园导航系统', '开发基于AR技术的智能校园导航系统', '2024-04-01', '2024-11-30', 'approved', '大学生创业项目', '33333333-3333-3333-3333-333333333340', '22222222-2222-2222-2222-222222222223',
 '{"project_name": "智能校园导航系统", "project_level": "省级", "project_rank": "良好"}'::jsonb)
ON CONFLICT (id) DO NOTHING;

-- 创业实践项目
INSERT INTO credit_activities (id, title, description, start_date, end_date, status, category, owner_id, reviewer_id, details)
VALUES
('44444444-4444-4444-4444-444444444452', '校园咖啡厅创业实践', '在校内开设咖啡厅，提供咖啡和简餐服务', '2024-02-01', '2024-12-31', 'approved', '创业实践项目', '33333333-3333-3333-3333-333333333333', '22222222-2222-2222-2222-222222222224',
 '{"company_name": "校园咖啡厅", "legal_person": "张三", "share_percent": 60.00}'::jsonb),
('44444444-4444-4444-4444-444444444453', '校园快递代收点', '在宿舍区设立快递代收点，为同学提供便利服务', '2024-01-15', '2024-12-31', 'approved', '创业实践项目', '33333333-3333-3333-3333-333333333334', '22222222-2222-2222-2222-222222222222',
 '{"company_name": "校园快递代收点", "legal_person": "李四", "share_percent": 80.00}'::jsonb)
ON CONFLICT (id) DO NOTHING;

-- 论文专利
INSERT INTO credit_activities (id, title, description, start_date, end_date, status, category, owner_id, reviewer_id, details)
VALUES
('44444444-4444-4444-4444-444444444454', '基于深度学习的图像识别算法研究', '发表关于深度学习在图像识别领域应用的学术论文', '2024-01-01', '2024-06-30', 'approved', '论文专利', '33333333-3333-3333-3333-333333333335', '22222222-2222-2222-2222-222222222223',
 '{"title": "基于深度学习的图像识别算法研究", "category": "学术论文", "rank": "核心期刊"}'::jsonb),
('44444444-4444-4444-4444-444444444455', '智能家居控制系统专利', '申请智能家居控制系统的实用新型专利', '2024-03-01', '2024-09-30', 'approved', '论文专利', '33333333-3333-3333-3333-333333333336', '22222222-2222-2222-2222-222222222224',
 '{"title": "智能家居控制系统", "category": "实用新型专利", "rank": "已授权"}'::jsonb)
ON CONFLICT (id) DO NOTHING;

-- ========================================
-- 3. 插入活动参与者数据
-- ========================================

INSERT INTO activity_participants (activity_id, user_id, credits)
VALUES
-- 互联网+创新创业大赛参与者
('44444444-4444-4444-4444-444444444444', '33333333-3333-3333-3333-333333333333', 2.0),
('44444444-4444-4444-4444-444444444444', '33333333-3333-3333-3333-333333333334', 1.5),
('44444444-4444-4444-4444-444444444444', '33333333-3333-3333-3333-333333333335', 1.0),

-- 大学生创新创业训练计划参与者
('44444444-4444-4444-4444-444444444445', '33333333-3333-3333-3333-333333333334', 2.5),
('44444444-4444-4444-4444-444444444445', '33333333-3333-3333-3333-333333333336', 2.0),
('44444444-4444-4444-4444-444444444445', '33333333-3333-3333-3333-333333333337', 1.5),

-- 科技创新实验室项目参与者
('44444444-4444-4444-4444-444444444446', '33333333-3333-3333-3333-333333333335', 3.0),
('44444444-4444-4444-4444-444444444446', '33333333-3333-3333-3333-333333333338', 2.5),
('44444444-4444-4444-4444-444444444446', '33333333-3333-3333-3333-333333333339', 2.0),

-- 数学建模竞赛参与者
('44444444-4444-4444-4444-444444444447', '33333333-3333-3333-3333-333333333336', 2.0),
('44444444-4444-4444-4444-444444444447', '33333333-3333-3333-3333-333333333340', 1.5),

-- ACM程序设计竞赛参与者
('44444444-4444-4444-4444-444444444448', '33333333-3333-3333-3333-333333333337', 2.5),
('44444444-4444-4444-4444-444444444448', '33333333-3333-3333-3333-333333333339', 2.0),

-- 电子设计竞赛参与者
('44444444-4444-4444-4444-444444444449', '33333333-3333-3333-3333-333333333338', 3.0),
('44444444-4444-4444-4444-444444444449', '33333333-3333-3333-3333-333333333340', 2.5)
ON CONFLICT DO NOTHING;

-- ========================================
-- 4. 插入申请数据
-- ========================================

INSERT INTO applications (activity_id, user_id, status, applied_credits, awarded_credits)
VALUES
-- 互联网+创新创业大赛申请
('44444444-4444-4444-4444-444444444444', '33333333-3333-3333-3333-333333333333', 'approved', 2.0, 2.0),
('44444444-4444-4444-4444-444444444444', '33333333-3333-3333-3333-333333333334', 'approved', 2.0, 1.5),
('44444444-4444-4444-4444-444444444444', '33333333-3333-3333-3333-333333333335', 'approved', 1.5, 1.0),

-- 大学生创新创业训练计划申请
('44444444-4444-4444-4444-444444444445', '33333333-3333-3333-3333-333333333334', 'approved', 3.0, 2.5),
('44444444-4444-4444-4444-444444444445', '33333333-3333-3333-3333-333333333336', 'approved', 2.5, 2.0),
('44444444-4444-4444-4444-444444444445', '33333333-3333-3333-3333-333333333337', 'approved', 2.0, 1.5),

-- 科技创新实验室项目申请
('44444444-4444-4444-4444-444444444446', '33333333-3333-3333-3333-333333333335', 'approved', 3.5, 3.0),
('44444444-4444-4444-4444-444444444446', '33333333-3333-3333-3333-333333333338', 'approved', 3.0, 2.5),
('44444444-4444-4444-4444-444444444446', '33333333-3333-3333-3333-333333333339', 'approved', 2.5, 2.0),

-- 数学建模竞赛申请
('44444444-4444-4444-4444-444444444447', '33333333-3333-3333-3333-333333333336', 'approved', 2.5, 2.0),
('44444444-4444-4444-4444-444444444447', '33333333-3333-3333-3333-333333333340', 'approved', 2.0, 1.5),

-- ACM程序设计竞赛申请
('44444444-4444-4444-4444-444444444448', '33333333-3333-3333-3333-333333333337', 'approved', 3.0, 2.5),
('44444444-4444-4444-4444-444444444448', '33333333-3333-3333-3333-333333333339', 'approved', 2.5, 2.0),

-- 电子设计竞赛申请
('44444444-4444-4444-4444-444444444449', '33333333-3333-3333-3333-333333333338', 'approved', 3.5, 3.0),
('44444444-4444-4444-4444-444444444449', '33333333-3333-3333-3333-333333333340', 'approved', 3.0, 2.5)
ON CONFLICT (activity_id, user_id) DO NOTHING;

-- ========================================
-- 5. 插入附件数据
-- ========================================

INSERT INTO attachments (activity_id, file_name, original_name, file_size, file_type, file_category, description, uploaded_by)
VALUES
-- 互联网+创新创业大赛附件
('44444444-4444-4444-4444-444444444444', 'project_proposal_2024001.pdf', '项目申请书.pdf', 2048576, '.pdf', 'document', '项目申请书', '33333333-3333-3333-3333-333333333333'),
('44444444-4444-4444-4444-444444444444', 'project_presentation_2024001.pptx', '项目展示PPT.pptx', 5120000, '.pptx', 'presentation', '项目展示PPT', '33333333-3333-3333-3333-333333333333'),
('44444444-4444-4444-4444-444444444444', 'project_demo_2024001.mp4', '项目演示视频.mp4', 15728640, '.mp4', 'video', '项目演示视频', '33333333-3333-3333-3333-333333333333'),

-- 大学生创新创业训练计划附件
('44444444-4444-4444-4444-444444444445', 'innovation_plan_2024002.docx', '创新计划书.docx', 1536000, '.docx', 'document', '创新计划书', '33333333-3333-3333-3333-333333333334'),
('44444444-4444-4444-4444-444444444445', 'research_report_2024002.pdf', '研究报告.pdf', 3072000, '.pdf', 'document', '研究报告', '33333333-3333-3333-3333-333333333334'),

-- 科技创新实验室项目附件
('44444444-4444-4444-4444-444444444446', 'lab_project_2024003.pdf', '实验室项目报告.pdf', 4096000, '.pdf', 'document', '实验室项目报告', '33333333-3333-3333-3333-333333333335'),
('44444444-4444-4444-4444-444444444446', 'experiment_data_2024003.xlsx', '实验数据.xlsx', 1024000, '.xlsx', 'spreadsheet', '实验数据表格', '33333333-3333-3333-3333-333333333335'),

-- 数学建模竞赛附件
('44444444-4444-4444-4444-444444444447', 'math_model_2024004.pdf', '数学建模论文.pdf', 2560000, '.pdf', 'document', '数学建模论文', '33333333-3333-3333-3333-333333333336'),
('44444444-4444-4444-4444-444444444447', 'model_code_2024004.zip', '模型代码.zip', 2048000, '.zip', 'archive', '模型代码文件', '33333333-3333-3333-3333-333333333336'),

-- ACM程序设计竞赛附件
('44444444-4444-4444-4444-444444444448', 'acm_solutions_2024005.txt', 'ACM解题代码.txt', 512000, '.txt', 'document', 'ACM解题代码', '33333333-3333-3333-3333-333333333337'),
('44444444-4444-4444-4444-444444444448', 'acm_certificate_2024005.jpg', '获奖证书.jpg', 1024000, '.jpg', 'image', '获奖证书', '33333333-3333-3333-3333-333333333337'),

-- 电子设计竞赛附件
('44444444-4444-4444-4444-444444444449', 'electronic_design_2024006.pdf', '电子设计报告.pdf', 3584000, '.pdf', 'document', '电子设计报告', '33333333-3333-3333-3333-333333333338'),
('44444444-4444-4444-4444-444444444449', 'circuit_diagram_2024006.png', '电路图.png', 1536000, '.png', 'image', '电路设计图', '33333333-3333-3333-3333-333333333338')
ON CONFLICT DO NOTHING;

-- ========================================
-- 6. 更新活动审核信息
-- ========================================

UPDATE credit_activities SET
    review_comments = '项目创新性强，技术方案可行，同意通过',
    reviewed_at = CURRENT_TIMESTAMP
WHERE id IN (
    '44444444-4444-4444-4444-444444444444',
    '44444444-4444-4444-4444-444444444445',
    '44444444-4444-4444-4444-444444444446',
    '44444444-4444-4444-4444-444444444447',
    '44444444-4444-4444-4444-444444444448',
    '44444444-4444-4444-4444-444444444449',
    '44444444-4444-4444-4444-444444444450',
    '44444444-4444-4444-4444-444444444451',
    '44444444-4444-4444-4444-444444444452',
    '44444444-4444-4444-4444-444444444453',
    '44444444-4444-4444-4444-444444444454',
    '44444444-4444-4444-4444-444444444455'
);

-- ========================================
-- 7. 显示插入的数据统计
-- ========================================

SELECT '用户数据统计' as info, COUNT(*) as count FROM users
UNION ALL
SELECT '学分活动统计', COUNT(*) FROM credit_activities
UNION ALL
SELECT '参与者统计', COUNT(*) FROM activity_participants
UNION ALL
SELECT '申请统计', COUNT(*) FROM applications
UNION ALL
SELECT '附件统计', COUNT(*) FROM attachments;
