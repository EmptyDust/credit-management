# .github/workflows/deploy.yml

name: Deploy with Docker Compose

on:
  push:
    branches: ["master"] # ç›‘å¬ master åˆ†æ”¯çš„ push äº‹ä»¶

jobs:
  deploy:
    runs-on: ubuntu-latest # ä½¿ç”¨ GitHub æä¾›çš„è™šæ‹Ÿæœº

    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç ï¼ˆè¿™ä¸€æ­¥æ˜¯ä¸ºäº†è®©Actionå¯ä»¥è®¿é—®åˆ°ä»“åº“ä¿¡æ¯ï¼Œæ¯”å¦‚ä»“åº“URLï¼‰
      - name: Checkout repository
        uses: actions/checkout@v6

      # æ­¥éª¤2: SSH è¿æ¥åˆ°æœåŠ¡å™¨å¹¶æ‰§è¡Œéƒ¨ç½²è„šæœ¬
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }} # ä» Secrets è¯»å–æœåŠ¡å™¨ IP
          username: ${{ secrets.SERVER_USER }} # ä» Secrets è¯»å–ç”¨æˆ·å
          key: ${{ secrets.SERVER_SSH_KEY }} # ä» Secrets è¯»å– SSH ç§é’¥
          script: |
            # --- åœ¨æ‚¨çš„æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ ---

            # 1. å®šä¹‰é¡¹ç›®ç›®å½•å’Œä»“åº“URL
            # DOCKER_COMPOSE_PATH åº”è¯¥æ˜¯åœ¨ GitHub Secrets ä¸­è®¾ç½®çš„è·¯å¾„
            # ä¾‹å¦‚: /home/emptydust/credit-management
            APP_DIR="${{ secrets.DOCKER_COMPOSE_PATH }}"
            REPO_URL="https://github.com/${{ github.repository }}.git"

            # 2. æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä» GitHub å…‹éš†é¡¹ç›®
            if [ ! -d "$APP_DIR" ]; then
              echo "é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œæ­£åœ¨å…‹éš†ä»“åº“..."
              git clone $REPO_URL "$APP_DIR"
            fi

            # 3. è¿›å…¥é¡¹ç›®ç›®å½•å¹¶æ‹‰å–æœ€æ–°ä»£ç 
            cd "$APP_DIR"
            echo "æ­£åœ¨æ‹‰å–æœ€æ–°çš„ä»£ç ..."
            git checkout master
            git pull origin master

            # 4. ä½¿ç”¨ Docker Compose æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
            # --build: å¦‚æœæœåŠ¡çš„ä»£ç æˆ– Dockerfile å‘ç”Ÿå˜åŒ–ï¼Œä¼šé‡æ–°æ„å»ºé•œåƒ
            # -d: åœ¨åå°è¿è¡Œå®¹å™¨
            # --remove-orphans: ç§»é™¤åœ¨ compose æ–‡ä»¶ä¸­å·²ä¸å­˜åœ¨çš„æœåŠ¡çš„å®¹å™¨
            echo "æ­£åœ¨ä½¿ç”¨ Docker Compose æ„å»ºå’Œéƒ¨ç½²..."
            docker compose up --build -d --remove-orphans

            # 5. æ¸…ç†ä¸å†ä½¿ç”¨çš„æ—§é•œåƒï¼Œé‡Šæ”¾ç£ç›˜ç©ºé—´
            echo "æ­£åœ¨æ¸…ç†æ—§çš„ Docker é•œåƒ..."
            docker image prune -f

            echo "ğŸš€ éƒ¨ç½²å®Œæˆï¼"
