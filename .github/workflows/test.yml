name: Test Suite

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

env:
  GO_VERSION: '1.24'
  COVERAGE_THRESHOLD: 60

jobs:
  test-auth-service:
    name: Auth Service Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: |
            auth-service/go.sum
            test-utils/go.sum

      - name: Install dependencies
        run: |
          cd test-utils && go mod download
          cd ../auth-service && go mod download

      - name: Run auth-service tests
        env:
          REDIS_HOST: localhost
          REDIS_PORT: 6379
        run: |
          cd auth-service/tests
          go test -v -timeout 10m -coverprofile=coverage.out ./...

      - name: Generate coverage report
        run: |
          cd auth-service
          go tool cover -func=tests/coverage.out > coverage.txt
          cat coverage.txt

      - name: Check coverage threshold
        run: |
          cd auth-service
          COVERAGE=$(go tool cover -func=tests/coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "❌ Coverage ($COVERAGE%) is below threshold ($COVERAGE_THRESHOLD%)"
            exit 1
          fi
          echo "✅ Coverage ($COVERAGE%) meets threshold ($COVERAGE_THRESHOLD%)"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./auth-service/tests/coverage.out
          flags: auth-service
          name: auth-service-coverage

  test-activity-service:
    name: Activity Service Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: |
            credit-activity-service/go.sum
            test-utils/go.sum

      - name: Install dependencies
        run: |
          cd test-utils && go mod download
          cd ../credit-activity-service && go mod download

      - name: Run activity-service tests
        run: |
          cd credit-activity-service/tests
          go test -v -timeout 10m -coverprofile=coverage.out ./...

      - name: Generate coverage report
        run: |
          cd credit-activity-service
          go tool cover -func=tests/coverage.out > coverage.txt
          cat coverage.txt

      - name: Check coverage threshold
        run: |
          cd credit-activity-service
          COVERAGE=$(go tool cover -func=tests/coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "❌ Coverage ($COVERAGE%) is below threshold ($COVERAGE_THRESHOLD%)"
            exit 1
          fi
          echo "✅ Coverage ($COVERAGE%) meets threshold ($COVERAGE_THRESHOLD%)"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./credit-activity-service/tests/coverage.out
          flags: activity-service
          name: activity-service-coverage

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-auth-service, test-activity-service]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install dependencies
        run: |
          cd test-utils && go mod download

      - name: Run integration tests
        run: |
          echo "Integration tests would run here"
          echo "These test interactions between services"

  lint:
    name: Lint and Static Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          working-directory: auth-service
          args: --timeout=5m

      - name: Run golangci-lint for activity service
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          working-directory: credit-activity-service
          args: --timeout=5m

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./...'

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-auth-service, test-activity-service, test-integration, lint]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "Test Summary:"
          echo "Auth Service: ${{ needs.test-auth-service.result }}"
          echo "Activity Service: ${{ needs.test-activity-service.result }}"
          echo "Integration: ${{ needs.test-integration.result }}"
          echo "Lint: ${{ needs.lint.result }}"

          if [ "${{ needs.test-auth-service.result }}" != "success" ] || \
             [ "${{ needs.test-activity-service.result }}" != "success" ] || \
             [ "${{ needs.test-integration.result }}" != "success" ] || \
             [ "${{ needs.lint.result }}" != "success" ]; then
            echo "❌ Some tests failed"
            exit 1
          fi

          echo "✅ All tests passed!"
