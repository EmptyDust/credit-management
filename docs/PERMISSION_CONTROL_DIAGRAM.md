# 权限控制架构图

## 系统架构概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API Gateway                                    │
│                         (统一认证和权限控制)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  JWT Middleware  │  Auth Middleware  │  Permission Middleware              │
│  (Token验证)      │  (认证检查)        │  (权限控制)                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┼───────────────┐
                │               │               │
                ▼               ▼               ▼
    ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
    │   Auth Service  │ │  User Service   │ │Credit Activity  │
    │   (认证服务)     │ │   (用户服务)     │ │   Service       │
    │                 │ │                 │ │ (学分活动服务)   │
    └─────────────────┘ └─────────────────┘ └─────────────────┘
```

## 用户角色层级

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户角色层级                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐        │
│  │     学生        │    │     教师        │    │     管理员      │        │
│  │   (Student)     │    │   (Teacher)     │    │   (Admin)       │        │
│  │                 │    │                 │    │                 │        │
│  │ • 基础权限       │    │ • 学生权限      │    │ • 教师权限      │        │
│  │ • 查看个人信息   │    │ • 管理学生      │    │ • 管理教师      │        │
│  │ • 申请活动       │    │ • 创建活动      │    │ • 系统管理      │        │
│  │ • 查看申请       │    │ • 审核申请      │    │ • 删除活动      │        │
│  │ • 离开活动       │    │ • 管理参与者    │    │ • 用户管理      │        │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘        │
│           │                       │                       │                │
│           └───────────────────────┼───────────────────────┘                │
│                                   │                                        │
│                           权限继承关系                                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 详细权限控制矩阵

### 1. 用户管理权限

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户管理权限                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │     学生        │  │     教师        │  │     管理员      │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 操作                    │ 学生 │ 教师 │ 管理员 │ 说明              │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ 查看个人信息            │  ✅  │  ✅  │   ✅   │ 自己的信息        │    │
│  │ 修改个人信息            │  ✅  │  ✅  │   ✅   │ 自己的信息        │    │
│  │ 查看用户统计            │  ✅  │  ✅  │   ✅   │ 公开统计          │    │
│  │ 查看学生列表            │  ❌  │  ✅  │   ✅   │ 教师可管理学生    │    │
│  │ 创建学生账户            │  ❌  │  ✅  │   ✅   │ 教师可创建学生    │    │
│  │ 编辑学生信息            │  ❌  │  ✅  │   ✅   │ 教师可编辑学生    │    │
│  │ 删除学生账户            │  ❌  │  ✅  │   ✅   │ 教师可删除学生    │    │
│  │ 查看教师列表            │  ❌  │  ❌  │   ✅   │ 仅管理员          │    │
│  │ 创建教师账户            │  ❌  │  ❌  │   ✅   │ 仅管理员          │    │
│  │ 编辑教师信息            │  ❌  │  ❌  │   ✅   │ 仅管理员          │    │
│  │ 删除教师账户            │  ❌  │  ❌  │   ✅   │ 仅管理员          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2. 活动管理权限

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              活动管理权限                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │     学生        │  │     教师        │  │     管理员      │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 操作                    │ 学生 │ 教师 │ 管理员 │ 说明              │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ 查看活动列表            │  ✅  │  ✅  │   ✅   │ 所有用户          │    │
│  │ 查看活动详情            │  ✅  │  ✅  │   ✅   │ 所有用户          │    │
│  │ 查看活动统计            │  ✅  │  ✅  │   ✅   │ 所有用户          │    │
│  │ 创建活动                │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 编辑活动                │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 删除活动                │  ❌  │  ❌  │   ✅   │ 仅管理员          │    │
│  │ 审核活动                │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 导入活动                │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 导出活动                │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 查看活动报告            │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 批量创建活动            │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 批量编辑活动            │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 批量删除活动            │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3. 申请管理权限

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              申请管理权限                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │     学生        │  │     教师        │  │     管理员      │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 操作                    │ 学生 │ 教师 │ 管理员 │ 说明              │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ 查看自己的申请          │  ✅  │  ✅  │   ✅   │ 所有用户          │    │
│  │ 查看所有申请            │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 提交申请                │  ✅  │  ✅  │   ✅   │ 所有用户          │    │
│  │ 撤回申请                │  ✅  │  ✅  │   ✅   │ 所有用户          │    │
│  │ 审核申请                │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 查看申请统计            │  ✅  │  ✅  │   ✅   │ 所有用户          │    │
│  │ 导出申请列表            │  ✅  │  ✅  │   ✅   │ 所有用户          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4. 参与者管理权限

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              参与者管理权限                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │     学生        │  │     教师        │  │     管理员      │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 操作                    │ 学生 │ 教师 │ 管理员 │ 说明              │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ 查看参与者列表          │  ✅  │  ✅  │   ✅   │ 所有用户          │    │
│  │ 查看参与者统计          │  ✅  │  ✅  │   ✅   │ 所有用户          │    │
│  │ 导出参与者列表          │  ✅  │  ✅  │   ✅   │ 所有用户          │    │
│  │ 添加参与者              │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 设置参与者学分          │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 批量设置学分            │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 移除参与者              │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 批量移除参与者          │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 离开活动                │  ✅  │  ❌  │   ❌   │ 仅学生            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5. 附件管理权限

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              附件管理权限                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │     学生        │  │     教师        │  │     管理员      │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 操作                    │ 学生 │ 教师 │ 管理员 │ 说明              │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ 查看附件列表            │  ✅  │  ✅  │   ✅   │ 所有用户          │    │
│  │ 下载附件                │  ✅  │  ✅  │   ✅   │ 所有用户          │    │
│  │ 预览附件                │  ✅  │  ✅  │   ✅   │ 所有用户          │    │
│  │ 上传附件                │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 批量上传附件            │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 编辑附件信息            │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  │ 删除附件                │  ❌  │  ✅  │   ✅   │ 教师和管理员      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 权限控制流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              权限控制流程                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  用户请求 → API Gateway                                                    │
│      │                                                                     │
│      ▼                                                                     │
│  JWT Token 验证                                                             │
│      │                                                                     │
│      ▼                                                                     │
│  提取用户信息 (user_id, user_type)                                          │
│      │                                                                     │
│      ▼                                                                     │
│  权限中间件检查                                                             │
│      │                                                                     │
│      ├─ AllUsers()     → 所有认证用户                                      │
│      ├─ StudentOnly()  → 仅学生                                            │
│      ├─ TeacherOrAdmin() → 教师或管理员                                    │
│      └─ AdminOnly()    → 仅管理员                                          │
│      │                                                                     │
│      ▼                                                                     │
│  权限验证通过？                                                             │
│      │                                                                     │
│      ├─ 是 → 转发到微服务                                                  │
│      └─ 否 → 返回 403 Forbidden                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 权限中间件详细说明

### 1. AllUsers() - 所有认证用户

```go
// 适用于：查看个人信息、查看活动列表、查看申请等
func (m *PermissionMiddleware) AllUsers() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 只要用户已认证即可访问
        // 不检查具体用户类型
    }
}
```

### 2. StudentOnly() - 仅学生

```go
// 适用于：离开活动等学生特有操作
func (m *PermissionMiddleware) StudentOnly() gin.HandlerFunc {
    return func(c *gin.Context) {
        userType := getUserType(c)
        if userType != "student" {
            c.JSON(403, gin.H{"error": "仅学生可访问"})
            c.Abort()
            return
        }
    }
}
```

### 3. TeacherOrAdmin() - 教师或管理员

```go
// 适用于：创建活动、审核申请、管理参与者等
func (m *PermissionMiddleware) TeacherOrAdmin() gin.HandlerFunc {
    return func(c *gin.Context) {
        userType := getUserType(c)
        if userType != "teacher" && userType != "admin" {
            c.JSON(403, gin.H{"error": "需要教师或管理员权限"})
            c.Abort()
            return
        }
    }
}
```

### 4. AdminOnly() - 仅管理员

```go
// 适用于：删除活动、管理教师等敏感操作
func (m *PermissionMiddleware) AdminOnly() gin.HandlerFunc {
    return func(c *gin.Context) {
        userType := getUserType(c)
        if userType != "admin" {
            c.JSON(403, gin.H{"error": "需要管理员权限"})
            c.Abort()
            return
        }
    }
}
```

## 安全考虑

### 1. 权限继承

- 管理员拥有所有权限
- 教师拥有学生权限 + 管理权限
- 学生只有基础权限

### 2. 最小权限原则

- 每个用户只能访问必要的功能
- 敏感操作需要高级权限
- 数据访问受用户类型限制

### 3. 权限验证

- 前端和后端双重验证
- API 网关统一权限控制
- 微服务信任网关传递的用户信息

### 4. 审计日志

- 记录所有权限相关的操作
- 监控异常访问行为
- 定期审查权限分配

## 扩展建议

### 1. 细粒度权限

- 基于资源的权限控制
- 动态权限分配
- 临时权限授权

### 2. 权限缓存

- 缓存用户权限信息
- 减少权限检查开销
- 提高系统性能

### 3. 权限管理界面

- 可视化的权限配置
- 权限模板管理
- 批量权限操作
